TEST: A (single-table const AND/OR)
QUERY:
SELECT COUNT(*) FROM customer;

ENABLED POLICIES:
customer : (customer.c_acctbal > 0) AND ((customer.c_mktsegment = 'FURNITURE') OR (customer.c_mktsegment = 'HOUSEHOLD')) AND (customer.c_nationkey < 10)
customer : (customer.c_acctbal < 9000) AND ((customer.c_mktsegment = 'MACHINERY') OR (customer.c_mktsegment = 'HOUSEHOLD'))

EXPLAIN OFF (custom_filter.enabled=off):
Aggregate
  ->  Index Only Scan using cf_rls_k11_customer_c_nationkey_4 on customer

EXPLAIN ON (custom_filter.enabled=on):
ERROR: ERROR:  custom_filter[memctx_violation]: allocation escaped query context (label=artifact_blob rel=<global>)
--- ON notices ---
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:> NUMBER:0 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'FURNITURE' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:) AND:and LPAREN:( IDENT:customer.c_nationkey OP:< NUMBER:10 RPAREN:)
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:< NUMBER:9000 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'MACHINERY' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:)
NOTICE:  policy_eval: target=customer join_classes=[]
NOTICE:  policy_eval: policy[1] target=customer expr=(customer.c_acctbal > 0) AND ((customer.c_mktsegment = 'FURNITURE') OR (customer.c_mktsegment = 'HOUSEHOLD')) AND (customer.c_nationkey < 10) ast=y2 and (y3 or y4) and y6
NOTICE:  policy_eval: policy[2] target=customer expr=(customer.c_acctbal < 9000) AND ((customer.c_mktsegment = 'MACHINERY') OR (customer.c_mktsegment = 'HOUSEHOLD')) ast=y1 and (y5 or y4)
NOTICE:  policy_eval: atom y1 = const:customer.c_acctbal|<|9000
NOTICE:  policy_eval: atom y2 = const:customer.c_acctbal|>|0
NOTICE:  policy_eval: atom y3 = const:customer.c_mktsegment|=|FURNITURE
NOTICE:  policy_eval: atom y4 = const:customer.c_mktsegment|=|HOUSEHOLD
NOTICE:  policy_eval: atom y5 = const:customer.c_mktsegment|=|MACHINERY
NOTICE:  policy_eval: atom y6 = const:customer.c_nationkey|<|10
NOTICE:  policy_eval: combined_ast target=customer ast=y2 and (y3 or y4) and y6 and y1 and (y5 or y4)
NOTICE:  policy_eval: closure_count=1
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:> NUMBER:0 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'FURNITURE' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:) AND:and LPAREN:( IDENT:customer.c_nationkey OP:< NUMBER:10 RPAREN:)
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:< NUMBER:9000 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'MACHINERY' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:)
NOTICE:  policy_eval: target=customer join_classes=[]
NOTICE:  policy_eval: policy[1] target=customer expr=(customer.c_acctbal > 0) AND ((customer.c_mktsegment = 'FURNITURE') OR (customer.c_mktsegment = 'HOUSEHOLD')) AND (customer.c_nationkey < 10) ast=y2 and (y3 or y4) and y6
NOTICE:  policy_eval: policy[2] target=customer expr=(customer.c_acctbal < 9000) AND ((customer.c_mktsegment = 'MACHINERY') OR (customer.c_mktsegment = 'HOUSEHOLD')) ast=y1 and (y5 or y4)
NOTICE:  policy_eval: atom y1 = const:customer.c_acctbal|<|9000
NOTICE:  policy_eval: atom y2 = const:customer.c_acctbal|>|0
NOTICE:  policy_eval: atom y3 = const:customer.c_mktsegment|=|FURNITURE
NOTICE:  policy_eval: atom y4 = const:customer.c_mktsegment|=|HOUSEHOLD
NOTICE:  policy_eval: atom y5 = const:customer.c_mktsegment|=|MACHINERY
NOTICE:  policy_eval: atom y6 = const:customer.c_nationkey|<|10
NOTICE:  policy_eval: combined_ast target=customer ast=y2 and (y3 or y4) and y6 and y1 and (y5 or y4)
NOTICE:  policy_eval: closure_count=1

OURS EXECUTION:
ERROR: ERROR:  custom_filter[memctx_violation]: allocation escaped query context (label=artifact_blob rel=<global>)
--- Ours notices ---
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:> NUMBER:0 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'FURNITURE' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:) AND:and LPAREN:( IDENT:customer.c_nationkey OP:< NUMBER:10 RPAREN:)
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:< NUMBER:9000 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'MACHINERY' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:)
NOTICE:  policy_eval: target=customer join_classes=[]
NOTICE:  policy_eval: policy[1] target=customer expr=(customer.c_acctbal > 0) AND ((customer.c_mktsegment = 'FURNITURE') OR (customer.c_mktsegment = 'HOUSEHOLD')) AND (customer.c_nationkey < 10) ast=y2 and (y3 or y4) and y6
NOTICE:  policy_eval: policy[2] target=customer expr=(customer.c_acctbal < 9000) AND ((customer.c_mktsegment = 'MACHINERY') OR (customer.c_mktsegment = 'HOUSEHOLD')) ast=y1 and (y5 or y4)
NOTICE:  policy_eval: atom y1 = const:customer.c_acctbal|<|9000
NOTICE:  policy_eval: atom y2 = const:customer.c_acctbal|>|0
NOTICE:  policy_eval: atom y3 = const:customer.c_mktsegment|=|FURNITURE
NOTICE:  policy_eval: atom y4 = const:customer.c_mktsegment|=|HOUSEHOLD
NOTICE:  policy_eval: atom y5 = const:customer.c_mktsegment|=|MACHINERY
NOTICE:  policy_eval: atom y6 = const:customer.c_nationkey|<|10
NOTICE:  policy_eval: combined_ast target=customer ast=y2 and (y3 or y4) and y6 and y1 and (y5 or y4)
NOTICE:  policy_eval: closure_count=1
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:> NUMBER:0 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'FURNITURE' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:) AND:and LPAREN:( IDENT:customer.c_nationkey OP:< NUMBER:10 RPAREN:)
NOTICE:  policy_eval: target=customer tokens=LPAREN:( IDENT:customer.c_acctbal OP:< NUMBER:9000 RPAREN:) AND:and LPAREN:( LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'MACHINERY' RPAREN:) OR:or LPAREN:( IDENT:customer.c_mktsegment OP:= STRING:'HOUSEHOLD' RPAREN:) RPAREN:)
NOTICE:  policy_eval: target=customer join_classes=[]
NOTICE:  policy_eval: policy[1] target=customer expr=(customer.c_acctbal > 0) AND ((customer.c_mktsegment = 'FURNITURE') OR (customer.c_mktsegment = 'HOUSEHOLD')) AND (customer.c_nationkey < 10) ast=y2 and (y3 or y4) and y6
NOTICE:  policy_eval: policy[2] target=customer expr=(customer.c_acctbal < 9000) AND ((customer.c_mktsegment = 'MACHINERY') OR (customer.c_mktsegment = 'HOUSEHOLD')) ast=y1 and (y5 or y4)
NOTICE:  policy_eval: atom y1 = const:customer.c_acctbal|<|9000
NOTICE:  policy_eval: atom y2 = const:customer.c_acctbal|>|0
NOTICE:  policy_eval: atom y3 = const:customer.c_mktsegment|=|FURNITURE
NOTICE:  policy_eval: atom y4 = const:customer.c_mktsegment|=|HOUSEHOLD
NOTICE:  policy_eval: atom y5 = const:customer.c_mktsegment|=|MACHINERY
NOTICE:  policy_eval: atom y6 = const:customer.c_nationkey|<|10
NOTICE:  policy_eval: combined_ast target=customer ast=y2 and (y3 or y4) and y6 and y1 and (y5 or y4)
NOTICE:  policy_eval: closure_count=1

GROUND TRUTH SOURCE: rls
GT COUNT: 1025
